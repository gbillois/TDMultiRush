<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#2d2a68" />
    <script>
      (function ensureTrailingSlash() {
        const { pathname, search, hash } = window.location;
        if (pathname.endsWith("/")) return;
        const lastSegment = pathname.split("/").pop() || "";
        if (lastSegment.includes(".")) return;
        window.location.replace(`${pathname}/${search}${hash}`);
      })();
    </script>
    <title>MultipliRush TD</title>
    <link rel="icon" type="image/png" sizes="48x48" href="assets/icons/favicon-48x48.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png" />
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bangers&family=Nunito:wght@600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="game-shell" id="game-shell">
      <div class="phone-frame visual-style-castle">
        <section id="title-screen" class="title-screen">
          <div class="title-card">
            <p class="title-kicker">Tower defense des multiplications</p>
            <h1>MultipliRush TD</h1>
            <p>
              Défends ton château en répondant aux multiplications. Le jeu s'adapte à tes
              tables les moins maîtrisées.
            </p>
            <div class="title-actions">
              <button id="start-btn" type="button">Lancer la partie</button>
              <button id="open-tables-btn" type="button">Réglages</button>
              <button id="open-stats-btn" type="button">Voir le classement et la matrice</button>
            </div>
          </div>
        </section>

        <header class="hud">
          <div class="hud-item">
            <span class="hud-label">Vague</span>
            <strong id="wave-value">1</strong>
          </div>
          <div class="hud-item">
            <span class="hud-label" id="lives-label">Vies</span>
            <strong id="lives-value">20</strong>
          </div>
          <div class="hud-item">
            <span class="hud-label">Score</span>
            <strong id="score-value">0</strong>
          </div>
          <div class="hud-item">
            <span class="hud-label">Combo</span>
            <strong id="combo-value">x0</strong>
          </div>
          <div class="hud-item hud-item-coins">
            <span class="hud-label">Pièces d'or</span>
            <strong id="coins-value">0</strong>
          </div>
        </header>

        <main class="battlefield" id="battlefield">
          <div class="layer layer-sky"></div>
          <div class="layer layer-hills"></div>
          <div class="layer layer-forest"></div>
          <div class="path"></div>
          <img id="castle-door-img" class="castle-door" src="assets/pixel/castle-right.PNG" alt="Porte du château" />
          <img
            id="castle-fire"
            class="castle-fire hidden"
            src="assets/pixel/fire-castle.png"
            alt="Flammes sur le château"
          />

          <img id="tower-img" class="tower" src="assets/pixel/tower-arcane.PNG" alt="Tour de défense" />
          <img
            id="boss-dragon-img"
            class="boss-dragon hidden"
            src="assets/pixel/fiercedragon.PNG"
            alt="Dragon final"
          />

          <div id="enemy-layer" class="enemy-layer" aria-live="polite"></div>
          <div id="projectile-layer" class="projectile-layer"></div>
          <div id="fx-layer" class="fx-layer"></div>
          <div id="boss-rain-layer" class="boss-rain-layer hidden"></div>

          <div id="wave-banner" class="wave-banner">Niveau 1</div>
          <div id="boss-panel" class="boss-panel hidden">
            <p id="boss-progress-text" class="boss-progress-text">Dragon: 0/5</p>
            <div class="boss-fire-track">
              <div id="boss-fire-fill" class="boss-fire-fill"></div>
            </div>
            <p id="boss-timer-text" class="boss-timer-text">5.0s</p>
          </div>
          <div id="boss-victory-banner" class="boss-victory-banner hidden">
            Victoire ! Tu es le champion des multiplications
          </div>
          <div id="boss-defeat-overlay" class="boss-defeat-overlay hidden">
            <p>Le dragon a gagné, tu dois être plus rapide. Retour au niveau précédent, réessaie !</p>
            <button id="boss-defeat-go-btn" type="button">OK</button>
          </div>
          <div id="game-over" class="game-over hidden">
            <h2 id="game-over-title">Défaite</h2>
            <p id="game-over-text">Les gobelins ont passé ta défense.</p>
            <p id="final-score-text" class="final-score-text">Score final: 0</p>
            <div id="score-submit" class="score-submit">
              <label for="player-name-input">Ton nom pour le classement</label>
              <div class="score-submit-row">
                <input
                  id="player-name-input"
                  type="text"
                  maxlength="18"
                  placeholder="Ex: Alex"
                  autocomplete="nickname"
                />
                <button id="save-score-btn" type="button">Enregistrer</button>
              </div>
              <p id="score-save-feedback" class="score-save-feedback"></p>
            </div>
            <button id="restart-btn" type="button">Rejouer</button>
            <div class="leaderboard">
              <h3>Leaderboard</h3>
              <ol id="leaderboard-list"></ol>
            </div>
          </div>
        </main>

        <section class="question-panel">
          <div class="question-top">
            <div class="question-headline">
              <p class="question-title">Canon des Multiplications</p>
              <div class="mini-actions">
                <button id="open-shop-inline-btn" class="mini-action mini-action-shop" type="button">
                  Boutique
                </button>
                <button id="open-tables-inline-btn" class="mini-action" type="button">
                  Réglages
                </button>
                <button id="open-stats-inline-btn" class="mini-action" type="button">
                  Stats
                </button>
                <button id="open-debug-inline-btn" class="mini-action debug-hidden" type="button">
                  Debug
                </button>
                <button id="pause-btn" class="mini-action mini-action-pause" type="button">
                  Pause
                </button>
              </div>
            </div>
            <p id="question-text" class="question-text">6 x 7 = ?</p>
          </div>
          <div class="mode-select" id="mode-select">
            <button type="button" data-mode="simple">Mode Simple</button>
            <button type="button" data-mode="normal" class="active">Mode normal</button>
          </div>

          <div class="answer-row">
            <input id="answer-input" type="text" inputmode="numeric" readonly value="" />
            <button id="fire-btn" class="fire-btn" type="button">Tirer</button>
          </div>

          <p id="feedback" class="feedback">Réponse correcte = tir magique.</p>

          <div class="keypad" id="keypad">
            <button type="button" data-key="1">1</button>
            <button type="button" data-key="2">2</button>
            <button type="button" data-key="3">3</button>
            <button type="button" data-key="4">4</button>
            <button type="button" data-key="5">5</button>
            <button type="button" data-key="6">6</button>
            <button type="button" data-key="7">7</button>
            <button type="button" data-key="8">8</button>
            <button type="button" data-key="9">9</button>
            <button type="button" data-key="clear">C</button>
            <button type="button" data-key="0">0</button>
            <button type="button" data-key="back">⌫</button>
          </div>
        </section>

        <section id="tables-modal" class="tables-modal hidden">
          <div class="tables-card">
            <h2>Configurer les tables</h2>
            <p class="tables-subtitle">
              Choisis les tables actives. Le moteur favorise ensuite celles que tu maîtrises
              moins.
            </p>
            <div id="visual-style-select" class="visual-style-select">
              <p class="visual-style-label">Style visuel</p>
              <div class="visual-style-buttons">
                <button type="button" data-visual-style="basic">Basic</button>
                <button type="button" data-visual-style="castle" class="active">Castle</button>
                <button type="button" data-visual-style="fairy">Fairy</button>
              </div>
            </div>
            <div id="tables-grid" class="tables-grid"></div>
            <div class="tables-actions">
              <button id="reset-mastery-btn" type="button">Réinitialiser la progression</button>
              <button id="close-tables-btn" type="button">Fermer</button>
            </div>
          </div>
        </section>

        <section id="stats-modal" class="stats-modal hidden">
          <div class="stats-card">
            <h2>Leaderboard et Maîtrise</h2>
            <div class="leaderboard stats-board">
              <h3>Meilleurs scores</h3>
              <ol id="stats-leaderboard-list"></ol>
            </div>

            <h3 class="matrix-title">Matrice des Multiplications</h3>
            <p class="matrix-subtitle">Rouge = début, vert = maîtrisée (20 réussites)</p>
            <div class="matrix-wrap">
              <table id="mastery-matrix" class="result-matrix"></table>
            </div>

            <button id="close-stats-btn" type="button">Fermer</button>
          </div>
        </section>

        <section id="shop-modal" class="shop-modal hidden">
          <div class="shop-card">
            <h2>Boutique</h2>
            <p class="shop-subtitle">Débloque des skins pour Castle/Fairy (Basic exclu).</p>
            <div class="shop-wallet">Solde: <strong id="shop-coins-value">0</strong> pièces d'or</div>
            <div id="shop-style-note" class="shop-style-note"></div>
            <div class="shop-filters" id="shop-category-select">
              <button type="button" data-shop-category="tower" class="active">Tours</button>
              <button type="button" data-shop-category="castle">Châteaux</button>
              <button type="button" data-shop-category="projectile">Tirs</button>
            </div>
            <div id="shop-grid" class="shop-grid"></div>
            <div class="shop-actions">
              <button id="close-shop-btn" type="button">Fermer</button>
            </div>
          </div>
        </section>

        <section id="pause-modal" class="pause-modal hidden">
          <div class="pause-card">
            <h2>Pause</h2>
            <p>La partie est en pause.</p>
            <div class="pause-actions">
              <button id="resume-btn" type="button">Reprendre</button>
              <button id="back-title-btn" type="button">Retour à l'écran titre</button>
            </div>
          </div>
        </section>

        <section id="mode-confirm-modal" class="pause-modal hidden">
          <div class="pause-card">
            <h2>Confirmation</h2>
            <p id="mode-confirm-text">Changer de mode va démarrer une nouvelle partie.</p>
            <div class="pause-actions">
              <button id="mode-confirm-cancel-btn" type="button">Annuler</button>
              <button id="mode-confirm-accept-btn" type="button">Continuer</button>
            </div>
          </div>
        </section>
      </div>
      <section id="debug-modal" class="debug-modal hidden">
        <div class="debug-card">
          <h2>Debug Visuel</h2>
          <p class="debug-subtitle">Ajuste les éléments en direct et copie les valeurs.</p>

          <label class="debug-control">
            <span>Fond affiché</span>
            <select id="debug-world-select">
              <option value="auto">Auto (selon vague)</option>
              <option value="forest">Forêt</option>
              <option value="snow">Neige</option>
              <option value="mountains">Montagnes</option>
              <option value="desert">Désert</option>
              <option value="desolation">Désolation</option>
            </select>
          </label>

          <label class="debug-control">
            <span>Décalage vertical du fond</span>
            <input id="debug-bg-offset" type="range" min="-220" max="220" step="2" />
            <strong id="debug-bg-offset-value">0 px</strong>
          </label>

          <label class="debug-control">
            <span>Décalage vertical du chemin des ennemis</span>
            <input id="debug-enemy-path-offset" type="range" min="-200" max="200" step="2" />
            <strong id="debug-enemy-path-offset-value">0 px</strong>
          </label>

          <label class="debug-control">
            <span>Taille de la tour</span>
            <input id="debug-tower-scale" type="range" min="0.4" max="1.6" step="0.01" />
            <strong id="debug-tower-scale-value">1.00x</strong>
          </label>

          <label class="debug-control">
            <span>Position verticale de la tour</span>
            <input id="debug-tower-offset" type="range" min="-200" max="200" step="2" />
            <strong id="debug-tower-offset-value">0 px</strong>
          </label>

          <label class="debug-control">
            <span>Taille du château</span>
            <input id="debug-castle-scale" type="range" min="0.4" max="1.6" step="0.01" />
            <strong id="debug-castle-scale-value">1.00x</strong>
          </label>

          <label class="debug-control">
            <span>Position verticale du château</span>
            <input id="debug-castle-offset" type="range" min="-200" max="200" step="2" />
            <strong id="debug-castle-offset-value">0 px</strong>
          </label>

          <div class="debug-export-wrap">
            <p>Valeurs à me renvoyer</p>
            <textarea id="debug-export" readonly></textarea>
          </div>

          <div class="debug-actions">
            <button id="debug-reset-btn" type="button">Réinitialiser ce style</button>
            <button id="close-debug-btn" type="button">Fermer</button>
          </div>
        </div>
      </section>
    </div>

    <script src="./game.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((registration) => registration.update())
            .catch(() => {});
        });
      }
    </script>
  </body>
</html>
